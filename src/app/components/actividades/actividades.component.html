<section class="actividades-page">
	<header class="actividades-header">
		<div class="header-text">
			<h1>Actividades Deportivas</h1>
			<p class="subtitle">Explora y únete a las actividades disponibles</p>
		</div>
		<div class="header-actions">
			@if(authService.isAdmin() || isOrganizador) {
			<button class="btn-sorteo-header" (click)="abrirModalSorteoCapitan(0, 0, 'Fútbol')" title="Sortear capitán de fútbol">
				<i class="bi bi-trophy-fill me-2"></i>
				Sortear Capitán
			</button>
			}
			@if(isOrganizador || authService.isAdmin()) {
			<button class="btn-crear-actividad" (click)="abrirModalCrearActividad()">
				<i class="bi bi-plus-circle me-2"></i>
				Añadir Actividad
			</button>
			}
		</div>
	</header>

	<main class="actividades-main">
		<div class="cards-grid">
            @for (actividad of actividades(); track $index) {
			<article class="activity-card">
				<div class="card-header">
					<div class="sport-icon">
						<i class="bi bi-trophy-fill"></i>
					</div>
					<div class="card-badge">
						@if(isFutureEvent(actividad.fechaEvento)) {
							<span class="badge active">Disponible</span>
					

						} @else {
							<span class="badge past">Finalizada</span>
						}
					</div>
				</div>

				<div class="card-content">
					<h3 class="activity-title">{{actividad.nombreActividad}}</h3>
					
					<div class="activity-info">
						<div class="info-item">
							<i class="bi bi-calendar-event"></i>
							<span>{{actividad.fechaEvento | date: 'dd MMM yyyy'}}</span>
						</div>
						@if(actividad.nombreActividad.toLowerCase() === "futbol" || actividad.nombreActividad.toLowerCase() === "basket" || actividad.nombreActividad.toLowerCase() === "baloncesto" || actividad.nombreActividad.toLowerCase() === "fútbol") {
						<div class="info-item">
							<i class="bi bi-people-fill"></i>		
							<span>Mín. {{actividad.minimoJugadores}} jugadores</span>
						</div>

						@if(estaInscritoEnEstaActividad(actividad.idEventoActividad) || this.authService.isAdmin() || this.organizadorService.esOrganizador()) {	
						<button class="btn-view-teams" (click)="verEquipos(actividad.idActividad, idEvento)">
							<i class="bi bi-shield-shaded"></i>
							<span>Ver Equipos</span>
						</button>
						}
					}
					</div>
				</div>

				<div class="card-footer">
					@if(isOrganizador || authService.isAdmin()) {
					<button class="btn-editar" (click)="abrirModalEditar(actividad)">
						<i class="bi bi-pencil-square"></i>
						<span>Editar</span>
					</button>
					} 
					
					@if(estaInscritoEnEstaActividad(actividad.idEventoActividad)) {
				
					
					<button class="btn-desapuntar" (click)="abrirModalDesapuntar(actividad.idEventoActividad)">
						<i class="bi bi-x-circle"></i>
						<span>Desapuntarse</span>
					</button>

					@if(showModalDesapuntar()) {
					<div class="modal-overlay" (click)="cerrarModalDesapuntar()">
						<div class="modal-container" (click)="$event.stopPropagation()">
							<div class="modal-header">
								<div class="modal-icon" style="background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);">
									<i class="bi bi-x-circle"></i>
								</div>
								<button class="modal-close" (click)="cerrarModalDesapuntar()">
									<i class="bi bi-x-lg"></i>
								</button>
							</div>
							<div class="modal-body">
								<h2>¿Seguro que quieres desapuntarte?</h2>
								<p>Esta acción cancelará tu inscripción en la actividad.</p>
							</div>
							<div class="modal-footer">
								<button class="btn-modal-cancel" (click)="cerrarModalDesapuntar()">
									Cancelar
								</button>
								<button class="btn-modal-confirm btn-modal-danger" (click)="confirmarDesapuntar()">
									<i class="bi bi-x-circle"></i>
									Desapuntarme
								</button>
							</div>
						</div>
					</div>
					}
					} @else if(estaInscritoEnAlgunaActividad()) {
					
						<button class="btn-otra-actividad" disabled title="Ya estás inscrito en otra actividad de este evento">
							<i class="bi bi-lock-fill"></i>
							<span>No disponible</span>
						</button>
					} @else if(isFutureEvent(actividad.fechaEvento)) {
						
						<button class="btn-primary" (click)="abrirModalUnirse(actividad.idEventoActividad)">
							<i class="bi bi-plus-circle-fill"></i>
							<span>Unirse</span>
						</button>
					} @else {
					
						<button class="btn-primary" disabled style="opacity: 0.5; cursor: not-allowed;">
							<i class="bi bi-check-circle-fill"></i>
							<span>Finalizada</span>
						</button>
					}
				</div>
			</article>
        }
		</div>
	</main>
</section>

@if(showModal()) {
<div class="modal-overlay" (click)="cerrarModal()">
	<div class="modal-container" (click)="$event.stopPropagation()">
		<div class="modal-header">
			<div class="modal-icon">
				<i class="bi bi-person-plus-fill"></i>
			</div>
			<button class="modal-close" (click)="cerrarModal()">
				<i class="bi bi-x-lg"></i>
			</button>
		</div>
		
		<div class="modal-body">
			<h2>Confirmar inscripción</h2>
			<p>Estás a punto de unirte a esta actividad</p>
			
			@if(actividadSeleccionada() && esActividadFutbol(actividadSeleccionada()!.idEventoActividad)) {
			<div class="capitan-option">
				<label class="checkbox-container">
					<input 
						type="checkbox" 
						[checked]="quiereSerCapitan()"
						(change)="toggleCapitan()"
					/>
					<span class="checkmark"></span>
					<div class="checkbox-content">
						<span class="checkbox-title">¿Quieres ser capitán?</span>
						<span class="checkbox-subtitle">Lidera y organiza a tu equipo de fútbol</span>
					</div>
				</label>
			</div>
			}
		</div>
		
		<div class="modal-footer">
			<button class="btn-modal-cancel" (click)="cerrarModal()">
				Cancelar
			</button>
			<button class="btn-modal-confirm" (click)="confirmarInscripcion()">
				<i class="bi bi-check2"></i>
				Confirmar
			</button>
		</div>
	</div>
</div>
}


@if(showModalCrearActividad()) {
<div class="modal-overlay" (click)="cerrarModalCrearActividad()">
	<div class="modal-container modal-lg" (click)="$event.stopPropagation()">
		<div class="modal-header">
			<div class="modal-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
				<i class="bi bi-plus-lg"></i>
			</div>
			<button class="modal-close" (click)="cerrarModalCrearActividad()">
				<i class="bi bi-x-lg"></i>
			</button>
		</div>
		
		<div class="modal-body">
			<h2>Añadir Actividad al Evento</h2>
			<p>Elige cómo quieres añadir la actividad</p>
	
			<div class="modal-tabs">
				<button class="tab-btn" [class.active]="tabActivo() === 'existente'" (click)="cambiarTab('existente')">
					<i class="bi bi-list-check"></i>
					Existente
				</button>
				<button class="tab-btn" [class.active]="tabActivo() === 'copiar'" (click)="cambiarTab('copiar')">
					<i class="bi bi-copy"></i>
					Copiar
				</button>
				<button class="tab-btn" [class.active]="tabActivo() === 'nueva'" (click)="cambiarTab('nueva')">
					<i class="bi bi-plus-circle"></i>
					Nueva
				</button>
			</div>

		
			@if(tabActivo() === 'existente') {
			<div class="tab-content">
				<div class="form-group">
					<label>Seleccionar actividad</label>
					<select class="form-select" [ngModel]="actividadSeleccionadaId()" (ngModelChange)="actividadSeleccionadaId.set($event)">
						<option [ngValue]="null">-- Selecciona una actividad --</option>
						@for(act of actividadesBase(); track act.idActividad) {
						<option [ngValue]="act.idActividad">{{act.nombre}} (Mín. {{act.minimoJugadores}} jugadores)</option>
						}
					</select>
				</div>
				<button class="btn-modal-confirm btn-full" (click)="confirmarCrearDesdeExistente()" [disabled]="!actividadSeleccionadaId()">
					<i class="bi bi-plus-circle"></i>
					Añadir Actividad
				</button>
			</div>
			}

		
			@if(tabActivo() === 'copiar') {
			<div class="tab-content">
				<div class="form-group">
					<label>Seleccionar evento</label>
					<select class="form-select" [ngModel]="eventoSeleccionadoParaCopiar()" (ngModelChange)="onEventoSeleccionadoChange($event)">
						<option [ngValue]="null">-- Selecciona un evento --</option>
						@for(ev of eventosDisponibles(); track ev.idEvento) {
						<option [ngValue]="ev.idEvento">#{{ev.idEvento}} - {{ev.fechaEvento | date:'dd/MM/yyyy'}}</option>
						}
					</select>
				</div>
				
				@if(actividadesDeEvento().length > 0) {
				<div class="form-group">
					<label>Seleccionar actividades a copiar</label>
					<select class="form-select form-select-multiple" multiple [ngModel]="actividadesSeleccionadasParaCopiar()" (ngModelChange)="actividadesSeleccionadasParaCopiar.set($event)">
						@for(act of actividadesDeEvento(); track act.idEventoActividad) {
						<option [ngValue]="act.idActividad">{{act.nombreActividad}}</option>
						}
					</select>
					<small class="text-muted">Mantén Ctrl para seleccionar varias</small>
				</div>
				<button class="btn-modal-confirm btn-full" (click)="confirmarCopiarActividad()" [disabled]="actividadesSeleccionadasParaCopiar().length === 0">
					<i class="bi bi-plus-circle"></i>
					Añadir Actividad
				</button>
				} @else if(eventoSeleccionadoParaCopiar()) {
				<p class="text-muted text-center">Este evento no tiene actividades</p>
				}
			</div>
			}

		
			@if(tabActivo() === 'nueva') {
			<div class="tab-content">
				<div class="form-group">
					<label>Nombre de la actividad</label>
					<input type="text" class="form-input" placeholder="Ej: Voleibol" [ngModel]="nombreNuevaActividad()" (ngModelChange)="nombreNuevaActividad.set($event)">
				</div>
				@if(esActividadConMinJugadores()) {
				<div class="form-group">
					<label>Mínimo jugadores <span class="required">*</span></label>
					<input type="number" class="form-input" [ngModel]="minimoJugadoresNueva()" (ngModelChange)="minimoJugadoresNueva.set($event)" min="1" required>
				</div>
				}
				<button class="btn-modal-confirm btn-full" (click)="confirmarCrearNueva()" [disabled]="!puedeCrearNuevaActividad()">
					<i class="bi bi-plus-circle"></i>
					Crear y Añadir
				</button>
			</div>
			}
		</div>
		
		<div class="modal-footer">
			<button class="btn-modal-cancel btn-full" (click)="cerrarModalCrearActividad()">
				Cancelar
			</button>
		</div>
	</div>
</div>
}


@if(showModalEditar()) {
<div class="modal-overlay" (click)="cerrarModalEditar()">
	<div class="modal-container" (click)="$event.stopPropagation()">
		<div class="modal-header">
			<div class="modal-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
				<i class="bi bi-pencil"></i>
			</div>
			<button class="modal-close" (click)="cerrarModalEditar()">
				<i class="bi bi-x-lg"></i>
			</button>
		</div>
		
		<div class="modal-body">
			<h2>Editar Actividad</h2>
			<p class="text-muted">Evento #{{actividadParaEditar()?.idEvento}}</p>
			
			<div class="form-group">
				<label>Nombre de la actividad <span class="required">*</span></label>
				<input type="text" class="form-input" [ngModel]="nombreEditar()" (ngModelChange)="nombreEditar.set($event)" placeholder="Ej: Fútbol" required>
			</div>
			
			@if(esActividadDeEquipoEditar()) {
			<div class="form-group">
				<label>Mínimo jugadores <span class="required">*</span></label>
				<input type="number" class="form-input" [ngModel]="minimoJugadoresEditar()" (ngModelChange)="minimoJugadoresEditar.set($event)" min="1" required>
				<small class="text-muted">Requerido para deportes de equipo</small>
			</div>
			}
			
			<button class="btn-eliminar-actividad" (click)="eliminarActividadDelEvento()">
				<i class="bi bi-trash3"></i>
				Eliminar del evento
			</button>
		</div>
		
		<div class="modal-footer">
			<button class="btn-modal-cancel" (click)="cerrarModalEditar()">
				Cancelar
			</button>
			<button class="btn-modal-confirm" (click)="confirmarEditar()" [disabled]="!puedeGuardarEdicion()">
				<i class="bi bi-check2"></i>
				Guardar Cambios
			</button>
		</div>
	</div>
</div>
}

@if(showModalEliminar()) {
<div class="modal-overlay" (click)="cerrarModalEliminar()">
	<div class="modal-container" (click)="$event.stopPropagation()">
		<div class="modal-header">
			<div class="modal-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
				<i class="bi bi-exclamation-triangle-fill"></i>
			</div>
			<button class="modal-close" (click)="cerrarModalEliminar()">
				<i class="bi bi-x-lg"></i>
			</button>
		</div>
		
		<div class="modal-body">
			<h2>¿Eliminar actividad del evento?</h2>
			<p><strong>{{actividadParaEditar()?.nombreActividad}}</strong></p>
			<p class="text-warning">⚠️ Esta acción no se puede deshacer</p>
			<p class="text-muted">Se eliminarán todas las inscripciones asociadas a esta actividad en el evento.</p>
		</div>
		
		<div class="modal-footer">
			<button class="btn-modal-cancel" (click)="cerrarModalEliminar()">
				Cancelar
			</button>
			<button class="btn-modal-confirm btn-modal-danger" (click)="confirmarEliminar()">
				<i class="bi bi-trash3"></i>
				Eliminar
			</button>
		</div>
	</div>
</div>
}

@if(showModalError()) {
<div class="modal-overlay" (click)="cerrarModalError()">
	<div class="modal-container" (click)="$event.stopPropagation()">
		<div class="modal-header">
			<div class="modal-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
				<i class="bi bi-x-circle-fill"></i>
			</div>
			<button class="modal-close" (click)="cerrarModalError()">
				<i class="bi bi-x-lg"></i>
			</button>
		</div>
		
		<div class="modal-body">
			<h2>Error al eliminar</h2>
			<p>{{mensajeError()}}</p>
			<p class="text-muted">Por favor, contacta con el administrador si el problema persiste.</p>
		</div>
		
		<div class="modal-footer">
			<button class="btn-modal-confirm btn-full" (click)="cerrarModalError()">
				Aceptar
			</button>
		</div>
	</div>
</div>
}
<!-- Modal Sorteo de Capitán -->
@if (showModalSorteoCapitan()) {
<div class="modal-overlay" (click)="cerrarModalSorteoCapitan()">
<div class="modal-container modal-sorteo-capitan" (click)="$event.stopPropagation()">
<div class="modal-header">
<div class="modal-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
<i class="bi bi-trophy-fill"></i>
</div>
<button class="modal-close" (click)="cerrarModalSorteoCapitan()">
<i class="bi bi-x-lg"></i>
</button>
</div>

<div class="modal-body">
<h2>Sorteo de Capitán</h2>
<p class="actividad-nombre">
<i class="bi bi-award me-2"></i>
{{actividadParaSorteo()?.nombreActividad}}
</p>

<div class="candidatos-info">
<div class="info-badge">
<i class="bi bi-people-fill me-2"></i>
{{candidatosCapitan().length}} candidato{{candidatosCapitan().length !== 1 ? 's' : ''}}
</div>
</div>

<!-- Lista de Candidatos -->
<div class="candidatos-lista">
@for (candidato of candidatosCapitan(); track candidato.idUsuario) {
<div class="candidato-card" [class.seleccionado]="capitanSeleccionado()?.idUsuario === candidato.idUsuario">
<div class="candidato-avatar">
@if (candidato.imagen) {
<img [src]="candidato.imagen" [alt]="candidato.usuario">
} @else {
<div class="avatar-placeholder">
<i class="bi bi-person-fill"></i>
</div>
}
</div>
<div class="candidato-info">
<div class="candidato-nombre">{{candidato.usuario}}</div>
<div class="candidato-curso">{{candidato.curso}}</div>
</div>
@if (capitanSeleccionado()?.idUsuario === candidato.idUsuario) {
<div class="candidato-badge">
<i class="bi bi-star-fill"></i>
Seleccionado
</div>
}
</div>
}
</div>

@if (capitanSeleccionado()) {
<div class="resultado-sorteo">
<i class="bi bi-trophy-fill me-2"></i>
<span>{{capitanSeleccionado().usuario}} será el capitán!</span>
</div>
}
</div>

<div class="modal-footer">
<button class="btn-modal-cancel" (click)="cerrarModalSorteoCapitan()">
Cancelar
</button>
<button class="btn-modal-sorteo" (click)="realizarSorteoRandom()" [disabled]="sorteoEnProgreso()">
<i class="bi bi-shuffle me-2"></i>
@if (modoEdicionCapitan()) {
Nuevo Sorteo
} @else {
Sortear
}
</button>
@if (capitanSeleccionado()) {
<button class="btn-modal-confirm" (click)="confirmarAsignacionCapitan()" [disabled]="sorteoEnProgreso()">
<i class="bi bi-check2 me-2"></i>
@if (modoEdicionCapitan()) {
Actualizar
} @else {
Confirmar
}
</button>
}
</div>
</div>
</div>
}

<!-- Modal de éxito -->
@if (showModalExito()) {
<div class="modal-overlay" (click)="cerrarModalExito()">
  <div class="modal-container modal-exito" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">
        <i class="bi bi-check-circle-fill text-success me-2"></i>
        Operación Exitosa!
      </h2>
      <button class="btn-close-modal" (click)="cerrarModalExito()" title="Cerrar">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="exito-content">
        <div class="exito-icon">
          <i class="bi bi-trophy-fill"></i>
        </div>
        <p class="exito-mensaje">{{ mensajeExito() }}</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-modal-confirm" (click)="cerrarModalExito()">
        <i class="bi bi-check2 me-2"></i>
        Entendido
      </button>
    </div>
  </div>
</div>
}
